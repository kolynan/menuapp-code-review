# Final Code Review Report: partnertables_v1.0_BASE.js

**Date:** 2026-02-22
**Reviewed by:** Claude (correctness + style sub-reviewers) + Codex (independent patch review)
**Rounds of discussion:** 1 (no P0/P1 disagreements — Round 2 not needed)
**File:** `pages/partnertables/partnertables_v1.0_BASE.js`
**Lines of code:** ~2499

---

## Summary

Large (~2500 LOC) React page managing restaurant tables — CRUD, QR code generation, drag-and-drop reorder, session management, and batch QR printing. Overall well-structured with good separation of helpers/sub-components. Two critical issues (XSS, unmount safety), several i18n violations, and a stale closure bug require attention.

---

## Confirmed Patches (both AI agree on fix)

### P0-1: XSS via unescaped values in print functions — CONFIRMED
**Lines:** 2053, 2087 | **Proposed by:** Claude | **Codex verdict:** APPROVE

`areaName`, `num`, `t()` returns, and `alt` text are interpolated raw into `document.write()` HTML. The file already has `escapeHtml()` (line 147) but it's not applied here. Note: `qrHeaderText`/`qrFooterText` ARE correctly escaped (lines 2081-2082), confirming this is an oversight.

**FINAL PATCH P0-1a** (printSingleQR, line 2053):
```js
// BEFORE:
<title>${t('partnertables.qr.single_title', { number: num })}</title>
...
<img src="${qrDataUrl}" width="300" height="300" alt="QR Code"/>
<div class="table-number">${t('partnertables.table')} №${num}</div>
${areaName ? `<div class="table-area">${areaName}</div>` : ""}
<div class="scan-text">${t('partnertables.qr.scan_hint')}</div>

// AFTER:
<title>${escapeHtml(t('partnertables.qr.single_title', { number: num }))}</title>
...
<img src="${qrDataUrl}" width="300" height="300" alt="${escapeHtml(t('partnertables.qr.alt'))}"/>
<div class="table-number">${escapeHtml(t('partnertables.table'))} №${escapeHtml(num)}</div>
${areaName ? `<div class="table-area">${escapeHtml(areaName)}</div>` : ""}
<div class="scan-text">${escapeHtml(t('partnertables.qr.scan_hint'))}</div>
```

**FINAL PATCH P0-1b** (printBatchQR, line 2087):
```js
// BEFORE:
<img src="${dataUrl}" width="${size}" height="${size}" alt="QR"/>
${qrShowNumber ? `<div class="table-number">${t('partnertables.table')} №${num}</div>` : ""}
${qrShowArea ? `<div class="table-area">${areaName}</div>` : ""}
<div class="scan-text">${t('partnertables.qr.scan_hint')}</div>

// AFTER:
<img src="${dataUrl}" width="${size}" height="${size}" alt="${escapeHtml(t('partnertables.qr.alt'))}"/>
${qrShowNumber ? `<div class="table-number">${escapeHtml(t('partnertables.table'))} №${escapeHtml(num)}</div>` : ""}
${qrShowArea ? `<div class="table-area">${escapeHtml(areaName)}</div>` : ""}
<div class="scan-text">${escapeHtml(t('partnertables.qr.scan_hint'))}</div>
```

> **Note:** Codex also found the hardcoded `alt="QR Code"` / `alt="QR"` should be localized — incorporated into the patch above.

---

### P0-2: QRCodeImage — async callback sets state after unmount — CONFIRMED
**Lines:** 332-372 | **Proposed by:** Claude | **Codex verdict:** APPROVE

No cleanup returned from `useEffect`. Async `loadImage()` callback calls `setReady(true)` after component unmounts. Also `ready` not reset on prop change → stale QR shown at full opacity.

**FINAL PATCH P0-2:**
```js
// REPLACE lines 332-372:
  useEffect(() => {
    if (!canvasRef.current || !value) return;
    setReady(false);
    let cancelled = false;
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');

    QRCode.toCanvas(canvas, value, {
      width: size,
      margin: 2,
      errorCorrectionLevel: logoUrl ? 'H' : 'M',
    }, async (err) => {
      if (err || cancelled) return;

      if (logoUrl) {
        try {
          const logo = await loadImage(logoUrl);
          if (cancelled) return;
          const logoSize = size * 0.2;
          const logoX = (size - logoSize) / 2;
          const logoY = (size - logoSize) / 2;

          ctx.beginPath();
          ctx.arc(size / 2, size / 2, logoSize / 2 + 3, 0, Math.PI * 2);
          ctx.fillStyle = '#ffffff';
          ctx.fill();

          ctx.save();
          ctx.beginPath();
          ctx.arc(size / 2, size / 2, logoSize / 2, 0, Math.PI * 2);
          ctx.clip();
          ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);
          ctx.restore();
        } catch {}
      }

      if (!cancelled) setReady(true);
    });

    return () => { cancelled = true; };
  }, [value, size, logoUrl]);
```

---

### P1-1: Hardcoded Russian fallback strings — CONFIRMED
**Lines:** 1218, 1834, 1846 | **Proposed by:** Claude | **Codex verdict:** APPROVE

**FINAL PATCH:**
```js
// Line 1218:
const baseMsg = t('partnertables.error.table_exists', { number: num });

// Line 1834:
const baseMsg = t('partnertables.error.table_exists', { number });

// Line 1846:
const baseMsg = t('partnertables.error.code_exists', { code: fullCode });
```

---

### P1-2: Hardcoded '0000' fallback on placeholder — CONFIRMED
**Line:** 1042 | **Proposed by:** Claude | **Codex verdict:** APPROVE

**FINAL PATCH:**
```js
placeholder={t('partnertables.code_settings.prefix_placeholder')}
```

---

### P1-3: `.toLowerCase()` on `t()` — locale-unsafe — CONFIRMED (IMPROVED)
**Line:** 1080 | **Proposed by:** Claude | **Codex verdict:** IMPROVE

Codex improvement: localize the whole phrase (including arrow + number) as one key, not just a lowercase variant. This avoids grammar/case problems per locale.

**FINAL PATCH (Codex's improved version):**
```js
// BEFORE:
<span> → {t('partnertables.table')?.toLowerCase()} 1</span>

// AFTER:
<span>{t('partnertables.code_settings.example_result', { number: 1 })}</span>
// i18n value example: " → стол 1" (RU), " → table 1" (EN)
```

---

### P1-6: `reload` useCallback — stale closure — CONFIRMED (IMPROVED)
**Lines:** 1277-1308 | **Proposed by:** Claude | **Codex verdict:** IMPROVE

Both AIs agree on `hasAutoExpandedRef`. Codex adds: also fix effect deps to include `reload` and use functional `setExpandedAreas`.

**FINAL PATCH (merged):**
```js
// Add ref:
const hasAutoExpandedRef = useRef(false);

// REPLACE reload:
const reload = useCallback(async () => {
  setLoading(true);
  setLoadError(false);
  try {
    const u = await getUser();
    setUser(u);
    const pId = u?.partner || "";
    const [p, areasData, tablesData, sessionsData] = await Promise.all([
      loadPartner(pId),
      listFor("Area", pId),
      listFor("Table", pId),
      loadSessions(pId),
    ]);
    setPartner(p);
    setAreasRaw(areasData || []);
    setTablesRaw(tablesData || []);
    setActiveSessions(sessionsData || []);

    if (!hasAutoExpandedRef.current) {
      hasAutoExpandedRef.current = true;
      const allAreaIds = (areasData || []).map(a => String(a.id));
      allAreaIds.push("none");
      setExpandedAreas(new Set(allAreaIds));
    }
  } catch (e) {
    setLoadError(true);
    toast.error(t('partnertables.error.load'), { id: STORAGE_KEYS.TOAST_ID });
  } finally {
    setLoading(false);
  }
}, [t, loadSessions]);

// REPLACE useEffect (line 1310-1312):
useEffect(() => {
  if (uiStateLoaded) reload();
}, [uiStateLoaded, reload]);
```

---

### P2-1: `moveTableUp`/`moveTableDown` missing `reordering` guard — CONFIRMED
**Lines:** 1761, 1776 | **Proposed by:** Claude | **Codex verdict:** APPROVE

**FINAL PATCH:**
```js
async function moveTableUp(table, areaId, currentIndex) {
  if (reordering || currentIndex <= 0) return;
  // ... rest unchanged

async function moveTableDown(table, areaId, currentIndex) {
  if (reordering) return;
  const areaTables = tablesByArea.get(areaId) || [];
  if (currentIndex >= areaTables.length - 1) return;
  // ... rest unchanged
```

---

### P2-4: Magic number 250 — CONFIRMED
**Line:** 2056 | **Proposed by:** Claude | **Codex verdict:** APPROVE

**FINAL PATCH:**
```js
// Add to CONSTANTS section (~line 70):
const PRINT_WINDOW_RENDER_DELAY_MS = 250;

// Line 2056:
setTimeout(() => { printWindow.print(); printWindow.close(); }, PRINT_WINDOW_RENDER_DELAY_MS);
```

---

### P2-5: Indentation error — CONFIRMED
**Line:** 1142 | **Proposed by:** Claude | **Codex verdict:** APPROVE

**FINAL PATCH:**
```js
  const saveTableInFlightRef = useRef(false);
  const [reordering, setReordering] = useState(false);
```

---

### P3-1: Hardcoded `aria-label="Drag to reorder"` — CONFIRMED
**Line:** 461 | **Proposed by:** Claude | **Codex verdict:** APPROVE

**FINAL PATCH:**
```js
aria-label={t('partnertables.drag_to_reorder')}
```
(Note: `GripHandle` will need `t` via `useI18n()` or prop)

---

### P3-2: `№` symbol hardcoded — CONFIRMED (IMPROVED)
**Lines:** 2053, 2087 | **Proposed by:** Claude | **Codex verdict:** IMPROVE

Codex improvement: use a single i18n key for the full label instead of just moving the symbol.

**FINAL PATCH:**
```js
// Instead of: ${escapeHtml(t('partnertables.table'))} №${escapeHtml(num)}
// Use:        ${escapeHtml(t('partnertables.qr.table_number_label', { number: num }))}
// i18n: "Стол №{number}" (RU), "Table #{number}" (EN)
```

---

### P3-3: `→` arrow outside `t()` — CONFIRMED (IMPROVED)
**Line:** 2394 | **Proposed by:** Claude | **Codex verdict:** IMPROVE

Codex improvement: use a `<ChevronRight aria-hidden />` icon instead of a text arrow.

---

## New Issues Found by Codex

### NEW-1 (P2): Hardcoded fallback `code || '000'` in CodeSettingsForm preview
**Line:** 1078 | **Found by:** Codex

```js
// BEFORE:
{code || '000'} + {String(1).padStart(digits, '0')} = {(code || '000') + String(1).padStart(digits, '0')}

// AFTER:
{code || t('partnertables.code_settings.prefix_placeholder')} + ...
```

### NEW-2 (P2): Hardcoded `|| "?"` in dialog description
**Line:** 2292 | **Found by:** Codex

```js
// BEFORE:
t('partnertables.dialog.table.code_unified', { code: unifiedCode, number: tableForm.number || "?" })

// AFTER:
t('partnertables.dialog.table.code_unified', {
  code: unifiedCode,
  number: tableForm.number || t('partnertables.dialog.table.unknown_number'),
})
```

### NEW-3 (P3): Hardcoded input placeholders `"1"` and `"1234"`
**Lines:** 2295, 2297 | **Found by:** Codex

```js
// Line 2295: placeholder="1" → placeholder={t('partnertables.dialog.table.number_placeholder')}
// Line 2297: placeholder="1234" → placeholder={t('partnertables.dialog.table.code_placeholder')}
```

### NEW-4 (P3): Hardcoded `"—"` fallback in TableCodeDisplay
**Line:** 516 | **Found by:** Codex

```js
// BEFORE:
const code = table?.code || "—";

// AFTER (pass t to component):
const code = table?.code || t('partnertables.table.code_missing');
```

---

## Disputed Patches (AI disagree — Arman decides)

### DISPUTE-1: `console.error` calls (lines 576, 1272, 1626, 1882, 1975)

| | Claude's Position | Codex's Position |
|---|---|---|
| **Priority** | P1 | P3/optional |
| **Argument** | CLAUDE.md rule title says "No Debug Logs". `console.error` leaks internal error details (stack traces, API paths) to browser console. All catch blocks already show `toast.error()`. | CLAUDE.md rule body says "Remove all `console.log`", not `console.error`. Removing errors hurts diagnosability. |
| **Claude's patch** | Remove all 5 `console.error` calls | — |
| **Codex's patch** | Keep as-is, or gate: `if (process.env.NODE_ENV !== 'production') console.error(...)` | — |

### DISPUTE-2: `window.confirm()` (line 1965)

| | Claude's Position | Codex's Position |
|---|---|---|
| **Priority** | P1 | P2/optional |
| **Argument** | `confirm()` is blocked in cross-origin iframes (Base44 may embed pages). Not styleable. Freezes React event loop. May silently return `false`. | No explicit CLAUDE.md rule bans `confirm()`. Full Dialog replacement is scope-heavy. Just fix the i18n key. |
| **Claude's patch** | Replace with React `<Dialog>` + state | — |
| **Codex's patch** | Keep `window.confirm(t('partnertables.session.close_confirm'))` | — |

### DISPUTE-3: `setDragImage` rename (line 1400)

| | Claude's Position | Codex's Position |
|---|---|---|
| **Priority** | P2 | Drop |
| **Argument** | Name shadows browser API `DataTransfer.setDragImage()`, confusing for maintenance | No actual runtime bug — different objects. Optional readability rename at most. |

### DISPUTE-4: DRY refactor for `moveTableUp`/`moveTableDown` (lines 1761-1789)

| | Claude's Position | Codex's Position |
|---|---|---|
| **Priority** | P2 | Drop |
| **Argument** | Identical bodies except direction → extract helper | Adds churn without rule-driven benefit. With P2-1 guard, both are fine. |

---

## Summary

| Metric | Count |
|--------|-------|
| **Confirmed patches** | 12 (P0: 2, P1: 4, P2: 3, P3: 3) |
| **Disputed patches** | 4 (Arman decides) |
| **New issues by Codex** | 4 (P2: 2, P3: 2) |
| **Rounds of discussion** | 1 |
| **Total unique issues** | 20 |

### Fix Priority Order
1. **P0-1** — XSS in print functions (security)
2. **P0-2** — QRCodeImage unmount safety (stability)
3. **P1-1** — Russian fallbacks (i18n)
4. **P1-2** — '0000' fallback (i18n)
5. **P1-3** — `.toLowerCase()` on `t()` (i18n, improved by Codex)
6. **P1-6** — `reload` stale closure (logic, improved by Codex)
7. **P2-1** — moveTable reordering guard (race condition)
8. **P2-4** — Magic number extraction
9. **P2-5** — Indentation fix
10. **NEW-1/2** — Hardcoded fallbacks found by Codex
11. **P3-***, **NEW-3/4** — i18n improvements
