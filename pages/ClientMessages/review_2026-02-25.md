# Code Review Report: clientmessages.jsx (ClientMessages)

**Date:** 2026-02-25
**Reviewed by:** Claude (correctness + style sub-reviewers)
**File:** pages/ClientMessages/clientmessages.jsx (242 lines)

## Summary
Most complex of the three pages. Has chained queries (accounts → messages → partners), optimistic mutation for mark-as-read, and relative date formatting. Four P1 issues found and fixed. Eight P2/P3 issues documented.

## Critical Issues (P0) — None

## High Priority (P1) — 4 Fixed
### BUG-CM-001 — Hardcoded Russian in formatMessageDate
- **Lines:** 125-133
- **What:** "Сегодня", "Вчера" hardcoded; `'ru-RU'` locale hardcoded
- **Fix:** Wrapped in `t()` calls; replaced locale with `undefined`

### BUG-CM-002 — Missing loading state while accounts load
- **Line:** 150
- **What:** Only `loadingMessages` checked; accounts loading showed empty state
- **Fix:** Added `loadingAccounts` from accounts query to loading check

### BUG-CM-003 — Hardcoded partner name fallback
- **Line:** 209
- **What:** `partner?.name || "..."` — hardcoded, untranslatable
- **Fix:** Changed to `t('clientmessages.unknown_partner', '...')`

### BUG-CM-004 — Missing null guard in partners queryFn
- **Line:** 62
- **What:** `messages.map()` without null guard; potential crash during refetch race
- **Fix:** Added `if (!messages || messages.length === 0) return [];`

## Medium Priority (P2) — Document Only
- **BUG-CM-005:** Messages queryKey doesn't include accounts dependency
- **BUG-CM-006:** Partners queryKey unstable (array reference)
- **BUG-CM-007:** Back button touch target below 44px (36px)
- **BUG-CM-008:** Back button missing aria-label
- **BUG-CM-009:** Message cards not keyboard accessible
- **BUG-CM-010:** onError callback deprecated in useQuery v5

## Low Priority (P3) — Document Only
- **BUG-CM-011:** Dead code: `!sortedMessages` always false
- **BUG-CM-012:** Unread dot is color-only indicator

## Statistics
- Total issues: 12 (P0: 0, P1: 4, P2: 6, P3: 2)
- Files analyzed: 1
- Lines of code: 242
- Fixes applied: 4
