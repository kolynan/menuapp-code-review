# Code Review Report: profile.jsx

**Reviewed by:** Claude (correctness + style analysis, sub-reviewer logic applied inline)
**Date:** 2026-02-27
**File:** pages/Profile/profile.jsx
**Lines:** 244
**Codex step:** SKIPPED (budget constraint, as instructed)

---

## Summary

The page is small and well-structured. i18n is largely correct, hooks are unconditional, no XSS or blob URL risks. However there are structural issues that need attention before this page is production-safe: (1) missing PartnerShell wrapper, which may expose the page without auth enforcement, (2) a setTimeout without cleanup that fires on unmounted components, and (3) a race condition in the async data loader. Several P2 style and naming issues round out the findings.

---

## Critical Issues (P0) -- Must Fix

None found.

---

## High Priority (P1) -- Should Fix

### [P1] Missing PartnerShell wrapper (line ~28)

- **What:** export default function Profile() contains all page logic and returns JSX directly. There is no PartnerShell wrapper. The Base44 pattern requires all partner-area pages to wrap content in PartnerShell with activeTab and keep logic in a separate ProfileContent() inner component.
- **Why it matters:** Without PartnerShell, the page does not enforce authentication/authorization through the shell. If the route is registered in PARTNER_SHELL_ROUTES in Layout.js but the component does not render PartnerShell, layout and auth context behave inconsistently.
- **Fix:** Extract page logic into ProfileContent(), and have Profile() return only the PartnerShell wrapper. Add import for PartnerShell (verify exact import path).

### [P1] setTimeout without cleanup -- state update on unmounted component (line ~93)

- **What:** After a successful save, a 2000ms setTimeout is scheduled to call setSaveStatus(idle). If the user navigates away within 2 seconds, the component unmounts and setSaveStatus fires on a dead component.
- **Why it matters:** Produces a React warning in development. Latent memory/state bug in production.
- **Fix:** Store the timer id in a useRef, cancel it in a useEffect cleanup function.

### [P1] Race condition -- no unmount guard on async data loading (lines ~44-74)

- **What:** loadUser() calls base44.auth.me() and base44.entities.Partner.get() with await. If the component unmounts before these resolve, all setter calls execute on an unmounted component.
- **Why it matters:** React warning in development; potential state corruption.
- **Fix:** Use an isMounted flag (set to true on mount, set to false in useEffect cleanup). Gate all setter calls behind if (isMounted).

---

## Medium Priority (P2) -- Recommended

### [P2] console.error calls left in production code (lines ~60, 64, 95)

- **What:** Three console.error calls remain: Failed to load partner, Failed to load user, Failed to save.
- **Rule:** No debug logs in production code.
- **Fix:** Remove all three. Errors are already surfaced to the user via toast.error().

### [P2] i18n key uses camelCase instead of snake_case (line ~193)

- **What:** t("profile.fullName") uses camelCase. All other keys in this file use snake_case: profile.no_restaurant, profile.load_error, profile.role, profile.restaurant, profile.title.
- **Rule:** i18n key format must be consistent -- snake_case throughout.
- **Fix:** Change to t("profile.full_name") and update the translation file.

### [P2] Back-navigation route hardcoded in two places (lines ~131, 176)

- **What:** navigate("/partnerhome") appears twice. If the route changes, both places need updating.
- **Rule:** No magic strings for repeated values -- use named constants.
- **Fix:** const BACK_ROUTE = "/partnerhome"; then navigate(BACK_ROUTE) in both places.

### [P2] Boolean state variable named without is/has prefix (line ~37)

- **What:** State variable loadError instead of isLoadError.
- **Rule:** Boolean variables must follow isXxx/hasXxx/canXxx convention.
- **Fix:** Rename to isLoadError throughout (useState declaration, conditional on line ~125, setLoadError call on line ~65).

### [P2] Magic string "global_admin" without named constant (line ~53)

- **What:** userData.partner \!== "global_admin" uses an inline domain value string.
- **Rule:** Magic strings that represent domain values should be named constants.
- **Fix:** const GLOBAL_ADMIN_PARTNER = "global_admin"; then reference GLOBAL_ADMIN_PARTNER in the condition.

### [P2] Back button touch target below 44px minimum (lines ~173-181)

- **What:** The back button uses size="sm" (shadcn default: ~32px height), below the 44px minimum touch target for mobile.
- **Rule:** Touch target minimum 44x44px for mobile.
- **Fix:** Change size="sm" to size="default", or add min-h-[44px] to the className.

---

## Low Priority (P3) -- Nice to Have

### [P3] getRoleLabel has no fallback for unknown role keys (lines ~101-104)

- **What:** t("profile.role." + userRole) returns the raw key string if the translation key does not exist. A new role added to the data model but not to translations would show as "profile.role.new_role" to the user.
- **Fix:** Check if t(key) === key and return t("profile.role.unknown") instead. Verify how useI18n handles missing keys before implementing.

### [P3] Save button touch target slightly below 44px (line ~232)

- **What:** Default shadcn Button height is typically 40px -- slightly below 44px minimum.
- **Fix:** Add min-h-[44px] to the className.

---

## Statistics

| Priority | Count | Issues |
|---|---|---|
| P0 | 0 | None |
| P1 | 3 | PartnerShell wrapper missing, setTimeout without cleanup, race condition |
| P2 | 6 | console.error x3, i18n key casing, hardcoded route x2, boolean naming, magic string, back button touch target |
| P3 | 2 | getRoleLabel fallback, save button touch target |
| **Total** | **11** | |

Estimated fix time: ~25-35 minutes for all P1 + P2 issues.

---

## Reviewer Notes

- No createObjectURL/revokeObjectURL needed -- no file/blob handling present.
- No dangerouslySetInnerHTML -- no XSS risk.
- No conditional hooks -- all hooks are unconditional at the top of the component.
- TDZ safety -- no forward reference issues detected.
- All imports are used -- no dead imports.
- Codex CLI review was skipped per budget constraint. Findings are from single-reviewer analysis. If strict two-reviewer confirmation is required, mark all as NEEDS VERIFICATION rather than CONFIRMED.
